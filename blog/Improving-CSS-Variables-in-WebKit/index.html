<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Sometimes, a Billion Laughs Aren't so Funny — Improving CSS Variables in WebKit | Widen Engineering</title>
  <meta name="description" content="As part of Widen's commitment to contributing back to the open-source community, we have sponsored work to improve the CSS variables implementation in WebKit...">

  <link rel="apple-touch-icon" sizes="57x57" href="/assets/images/favicon/apple-icon-57x57.png">
<link rel="apple-touch-icon" sizes="60x60" href="/assets/images/favicon/apple-icon-60x60.png">
<link rel="apple-touch-icon" sizes="72x72" href="/assets/images/favicon/apple-icon-72x72.png">
<link rel="apple-touch-icon" sizes="76x76" href="/assets/images/favicon/apple-icon-76x76.png">
<link rel="apple-touch-icon" sizes="114x114" href="/assets/images/favicon/apple-icon-114x114.png">
<link rel="apple-touch-icon" sizes="120x120" href="/assets/images/favicon/apple-icon-120x120.png">
<link rel="apple-touch-icon" sizes="144x144" href="/assets/images/favicon/apple-icon-144x144.png">
<link rel="apple-touch-icon" sizes="152x152" href="/assets/images/favicon/apple-icon-152x152.png">
<link rel="apple-touch-icon" sizes="180x180" href="/assets/images/favicon/apple-icon-180x180.png">
<link rel="icon" type="image/png" sizes="192x192"  href="/assets/images/favicon/android-icon-192x192.png">
<link rel="icon" type="image/png" sizes="32x32" href="/assets/images/favicon/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="96x96" href="/assets/images/favicon/favicon-96x96.png">
<link rel="icon" type="image/png" sizes="16x16" href="/assets/images/favicon/favicon-16x16.png">

<link rel="manifest" href="/assets/images/favicon/manifest.json"">

<meta name="msapplication-TileColor" content="#B72822">
<meta name="msapplication-TileImage" content="/assets/images/favicon/ms-icon-144x144.png" | relative_url }}">
<meta name="theme-color" content="#B72822">

  <link rel="stylesheet" href="/assets/css/app.css">
  <link rel="canonical" href="https://engineering.widen.com/blog/Improving-CSS-Variables-in-WebKit/">
  <link rel="alternate" type="application/rss+xml" title="Widen Engineering" href="/feed.xml" />
</head>


  <body>

    <div class="full-width">
      <header class="site-header" role="banner">
  <div class="wrapper">
    <div class="logo">
      <a href="/">
        <img width="400" alt="Widen Engineering Logo" src="https://embed.widencdn.net/img/widen/c17yrvuaac/400px@2x/Widen Engineering White Logo.png?u=mcuc7i">
      </a>
    </div>
    
      <a class="subscribe" target="_blank" title="Email Subscription" href="https://feedburner.google.com/fb/a/mailverify?uri=WidenEngineering">Subscribe to Updates</a>
    
  </div>
</header>

    </div>

    <div class="wrapper">

      <main class="content" role="main">

        <div class="post">
    <header>
        <h1><a title="Sometimes, a Billion Laughs Aren't so Funny — Improving CSS Variables in WebKit" href="/blog/Improving-CSS-Variables-in-WebKit/">Sometimes, a Billion Laughs Aren't so Funny — Improving CSS Variables in WebKit</a></h1>
        <time datetime="2021-04-24T00:00:00-05:00">Apr 24, 2021</time> • Tyler Wilcock
    </header>

    <article role="article">

      <style>
.bugzilla-subheader {
  font-size: 1.4rem;
}
</style>

<p>Widen, like many companies, makes heavy use of open-source technology, and we’ve made it a part of our mission to give back to this community that we benefit so much from. In light of this, in this post I’ll be talking about some improvements I made to the CSS variables implementation in WebKit.</p>

<h3 id="what-is-webkit">What is WebKit?</h3>

<p><a href="https://webkit.org/">WebKit</a> is an open-source browser engine that is most famous for powering Safari.  Safari is far from the only place
 you’ll find WebKit, however.  It’s behind every browser on iOS, all web content displayed on PlayStation systems, and in various GTK-based browsers
such as <a href="https://github.com/GNOME/epiphany">Gnome Web</a>.  WebKit is also deployed to millions of embedded
devices via the <a href="https://webkit.org/wpe/">WebKit Port for Embedded</a> (WPE) port.</p>

<h3 id="css-has-variables">CSS has variables?</h3>

<p>Yes!  You don’t need a CSS preprocessor to use variables in your CSS.  Here’s what the syntax looks like:</p>

<div class="language-css highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">:root</span> <span class="p">{</span>
  <span class="py">--gutter</span><span class="p">:</span> <span class="m">4px</span><span class="p">;</span>
<span class="p">}</span>

<span class="nt">section</span> <span class="p">{</span>
  <span class="nl">margin</span><span class="p">:</span> <span class="n">var</span><span class="p">(</span><span class="n">--gutter</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">@media</span> <span class="p">(</span><span class="n">min-width</span><span class="p">:</span> <span class="m">600px</span><span class="p">)</span> <span class="p">{</span>
  <span class="nd">:root</span> <span class="p">{</span>
    <span class="py">--gutter</span><span class="p">:</span> <span class="m">16px</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Because CSS variables are native to the web platform, they can do things CSS preprocessor variables can’t.  For example,
they can be used in media queries, and can be manipulated with JavaScript.</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 4px or 16px depending on current screen-width</span>
<span class="kd">const</span> <span class="nx">gutterSize</span> <span class="o">=</span> <span class="nx">getComputedStyle</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">documentElement</span><span class="p">)</span>
                    <span class="p">.</span><span class="nx">getPropertyValue</span><span class="p">(</span><span class="dl">'</span><span class="s1">--gutter</span><span class="dl">'</span><span class="p">)</span>
                    <span class="p">.</span><span class="nx">trim</span><span class="p">()</span>

<span class="nx">maximizeGutterButton</span><span class="p">.</span><span class="nx">onclick</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nb">document</span><span class="p">.</span><span class="nx">documentElement</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">setProperty</span><span class="p">(</span><span class="dl">'</span><span class="s1">--gutter</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">32px</span><span class="dl">'</span><span class="p">);</span>
<span class="p">})</span>
</code></pre></div></div>

<p>CSS variables are also known as custom properties.  For a more detailed overview of CSS variables, read more <a href="https://developer.mozilla.org/en-US/docs/Web/CSS/Using_CSS_custom_properties">on MDN</a>.</p>

<h3 id="improvements-to-webkits-css-variables-implementation">Improvements to WebKit’s CSS variables implementation</h3>

<p>You can find the diff for each fixed bug by following the <a href="https://bugs.webkit.org">bugs.webkit.org</a> sub-header link and clicking “Formatted Diff” on the
patch.</p>

<h4 id="safer-handling-of-overly-long-css-variables">Safer handling of overly long CSS variables</h4>
<div class="bugzilla-subheader"><a href="https://bugs.webkit.org/show_bug.cgi?id=216407">https://bugs.webkit.org/show_bug.cgi?id=216407</a></div>

<p>One useful property of CSS variables is that the value of one variable can be the expansion of another. However, this can get out of hand when used maliciously:</p>

<div class="language-css highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">:root</span> <span class="p">{</span>
  <span class="py">--prop1</span><span class="p">:</span> <span class="n">lol</span><span class="p">;</span>
  <span class="py">--prop2</span><span class="p">:</span> <span class="n">var</span><span class="p">(</span><span class="n">--prop1</span><span class="p">)</span> <span class="n">var</span><span class="p">(</span><span class="n">--prop1</span><span class="p">);</span>
  <span class="py">--prop3</span><span class="p">:</span> <span class="n">var</span><span class="p">(</span><span class="n">--prop2</span><span class="p">)</span> <span class="n">var</span><span class="p">(</span><span class="n">--prop2</span><span class="p">);</span>
  <span class="py">--prop4</span><span class="p">:</span> <span class="n">var</span><span class="p">(</span><span class="n">--prop3</span><span class="p">)</span> <span class="n">var</span><span class="p">(</span><span class="n">--prop3</span><span class="p">);</span>
  <span class="c">/* expand to --prop30 */</span>
<span class="p">}</span>
</code></pre></div></div>

<p>If allowed to run unchecked, the above snippet will result in the browser attempting to create approximately one billion instances of <code class="language-plaintext highlighter-rouge">--prop1</code>’s value (“lol”),
which is more than enough to run most systems out of memory.  Testing this in Safari on my 2019 MackBook Pro, 32gb of RAM was consumed within 30 seconds, and Safari eventually refused to load the page.</p>

<p>This is an example of the <a href="https://en.wikipedia.org/wiki/Billion_laughs_attack">billion laughs attack</a>, and before this patch all WebKit-based browsers were susceptible to it via CSS variables.  Now, any CSS variable value that requires more than 65536 expansions is treated as invalid, and the variable expansion process is ended early.</p>

<h4 id="enable-css-wide-keywords-to-be-used-as-variable-fallbacks">Enable CSS-wide keywords to be used as variable fallbacks</h4>
<div class="bugzilla-subheader"><a href="https://bugs.webkit.org/show_bug.cgi?id=197158">https://bugs.webkit.org/show_bug.cgi?id=197158</a></div>

<p>CSS variable expansions can specify fallback values in case the given variable is not available.  For example, see this
snippet where the <code class="language-plaintext highlighter-rouge">background-color</code> for <code class="language-plaintext highlighter-rouge">.foo</code> is either <code class="language-plaintext highlighter-rouge">--optional-theme-color</code> or <a href="https://developer.mozilla.org/en-US/docs/Web/CSS/revert"><code class="language-plaintext highlighter-rouge">revert</code></a>.</p>

<div class="language-css highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">.foo</span> <span class="p">{</span>
  <span class="c">/* Any other CSS value may also be used as a fallback. */</span>
  <span class="nl">background-color</span><span class="p">:</span> <span class="n">var</span><span class="p">(</span><span class="n">--optional-theme-color</span><span class="p">,</span> <span class="n">revert</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Before this patch, CSS-wide keywords were not parsed in the context of variable fallbacks, and therefore were always considered invalid values.  This
includes <code class="language-plaintext highlighter-rouge">inherit</code>, <code class="language-plaintext highlighter-rouge">initial</code>, <code class="language-plaintext highlighter-rouge">revert</code>, and <code class="language-plaintext highlighter-rouge">unset</code>.</p>

<h4 id="resolve-relative-path-urls-in-url-against-the-correct-base-url-when-css-variables-are-involved">Resolve relative-path URLs in <code class="language-plaintext highlighter-rouge">url()</code> against the correct base URL when CSS variables are involved</h4>
<div class="bugzilla-subheader"><a href="https://bugs.webkit.org/show_bug.cgi?id=198512">https://bugs.webkit.org/show_bug.cgi?id=198512</a></div>

<p>Given this folder structure:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>project/
├── index.html
└── assets/
|   └── ducky.png
└── styles/
    └── stylesheet.css
</code></pre></div></div>

<p>And these styles in <code class="language-plaintext highlighter-rouge">stylesheet.css</code>:</p>

<div class="language-css highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">:root</span> <span class="p">{</span>
  <span class="py">--background-url</span><span class="p">:</span> <span class="sx">url('../assets/ducky.png')</span><span class="p">;</span>
  <span class="py">--repeat-style</span><span class="p">:</span> <span class="nb">no-repeat</span><span class="p">;</span>
<span class="p">}</span>

<span class="nt">body</span> <span class="p">{</span>
  <span class="nl">background</span><span class="p">:</span> <span class="n">var</span><span class="p">(</span><span class="n">--background-url</span><span class="p">);</span>
<span class="p">}</span>

<span class="nt">div</span> <span class="p">{</span>
  <span class="nl">background</span><span class="p">:</span> <span class="sx">url('../assets/ducky.png')</span> <span class="n">var</span><span class="p">(</span><span class="n">--repeat-style</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Then the <code class="language-plaintext highlighter-rouge">url()</code>s should be resolved relative to the directory in which they originate.  In this case, this is the styles directory.</p>

<div class="language-css highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">url</span><span class="o">(</span><span class="s2">'../assets/ducky.png'</span><span class="o">);</span>
<span class="c">/* Should resolve to: https://domain.com/assets/ducky.png */</span>
</code></pre></div></div>

<p>However, before this patch, whenever a variable was present in a rule, <code class="language-plaintext highlighter-rouge">url()</code>s in that rule would unconditionally resolve relative to the base document URL (that of <code class="language-plaintext highlighter-rouge">index.html</code> here).
This means that all of the <code class="language-plaintext highlighter-rouge">url()</code>s above would fail to load our ducky.</p>

<p>To fix this, WebKit’s representation of <a href="https://drafts.csswg.org/css-variables/#pending-substitution-value">pending-substitution values</a> now
tracks the base URL that should be used to resolve any <code class="language-plaintext highlighter-rouge">url()</code> in the value, rather than unconditionally resolving them against the
base document URL.</p>

<h4 id="prevent-visited-styles-from-erroneously-being-applied-to-non-visited-links-when-css-variables-are-present-in-the-rule">Prevent :visited styles from erroneously being applied to non-visited links when CSS variables are present in the rule</h4>
<div class="bugzilla-subheader"><a href="https://bugs.webkit.org/show_bug.cgi?id=210525">https://bugs.webkit.org/show_bug.cgi?id=210525</a></div>

<p>Given:</p>

<div class="language-css highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">:root</span> <span class="p">{</span>
  <span class="py">--link-color</span><span class="p">:</span> <span class="no">green</span><span class="p">;</span>
  <span class="py">--link-color-visited</span><span class="p">:</span> <span class="no">red</span><span class="p">;</span>
<span class="p">}</span>

<span class="nc">.link</span> <span class="p">{</span>
  <span class="nl">color</span><span class="p">:</span> <span class="n">var</span><span class="p">(</span><span class="n">--link-color</span><span class="p">);</span>
<span class="p">}</span>
<span class="nc">.link</span><span class="nd">:visited</span> <span class="p">{</span>
  <span class="nl">color</span><span class="p">:</span> <span class="n">var</span><span class="p">(</span><span class="n">--link-color-visited</span><span class="p">);</span>
<span class="p">}</span>

<span class="o">&lt;</span><span class="nt">a</span> <span class="nt">class</span><span class="o">=</span><span class="s1">"link"</span> <span class="nt">href</span><span class="o">=</span><span class="s1">"https://www.widen.com"</span><span class="o">&gt;</span><span class="nt">Widen</span><span class="o">&lt;/</span><span class="nt">a</span><span class="o">&gt;</span>
</code></pre></div></div>

<p>WebKit used to erroneously apply the <code class="language-plaintext highlighter-rouge">:visited</code> styles for non-visited links when variables were part of the rule, meaning
the color of this link would always be red.</p>

<p>In WebKit’s style-building code, there’s a piece of state that manages where the styles it’s evaluating should be applied.  This can happen one of three ways:</p>

<ol>
  <li>Styles are applied to the set of non-visited styles</li>
  <li>Styles are applied to the set of <code class="language-plaintext highlighter-rouge">:visited</code> styles</li>
  <li>Styles are applied to both non-visited and <code class="language-plaintext highlighter-rouge">:visited</code> style sets</li>
</ol>

<p>The manifestation of the bug looked like this:</p>

<ol>
  <li>The parsing of the <code class="language-plaintext highlighter-rouge">.link:visited</code> style begins, and style-state is updated to register <code class="language-plaintext highlighter-rouge">:visited</code> styles.</li>
  <li>A CSS variable is encountered, so work begins to expand it.</li>
  <li>As part of this expansion, the style-state is manipulated to various values and unconditionally reset
  to point at the non-visited style set.</li>
  <li>Variable expansion completes, but because of the reset to the non-visited style-state in the previous step,
  the <code class="language-plaintext highlighter-rouge">:visited</code> styles are erroneously applied to the non-visited style set.</li>
</ol>

<p>One solution would be to keep track of the value of this style-state before variable expansion begins and reset it back to this
value in step 3.  I tried this, but it isn’t the cleanest solution, as one would have to remember to reset this state
any time the function returns.</p>

<p>Instead, any time this state is mutated during variable expansion, it’s now done so with a utility within WebKit called
<code class="language-plaintext highlighter-rouge">SetForScope</code>, which automatically rolls the changed state back to its original value when the <code class="language-plaintext highlighter-rouge">SetForScope</code> is destroyed.</p>

<h3 id="future-work">Future work</h3>

<p>Currently, CSS variables used in <code class="language-plaintext highlighter-rouge">@keyframes</code> animations in WebKit <a href="https://bugs.webkit.org/show_bug.cgi?id=201736">are broken</a>.
I haven’t got around to fixing this one yet, but hope to do so soon.</p>

<p>I’d like to thank Widen again for their full support in my work on this, and in general for enabling all of our development team
to give back to the open-source community.  If you’re interested in joining our team, check out our openings <a href="https://www.widen.com/careers">here</a>!</p>



    </article>

    
      
<div class="comments">
	<div id="disqus_thread"></div>
	<script type="text/javascript">
	    var disqus_shortname = 'widen-engineering';
	    (function() {
	        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
	        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
	        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
	    })();
	</script>
	<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>


    
</div>


      </main>

    </div>

    <div class="full-width">
      <div class="wrapper">
    <footer class="site-footer" role="contentinfo">
        <nav>
          <ul class="inline">
          
            
          
            
          
            
          
            
            <li>
                <a href="/open-source">Open Source Guidelines</a>
            </li>
            
          
            
          
            
          
            
          
          </ul>
          <br/>
        </nav >
        <nav>
          <ul class="site-social-links inline">
              <li><a target="_blank" title="RSS Feed" href="/feed.xml"><ion-icon name="logo-rss"></ion-icon></a></li>          
              <li><a target="_blank" title="GitHub" href="https://github.com/widen"><ion-icon name="logo-github"></ion-icon></a></li>
              <li><a target="_blank" title="Twitter" href="https://twitter.com/widendev"><ion-icon name="logo-twitter"></ion-icon></a></li>
          </ul>
        </nav>
        <p>© Copyright 2021, <a title="Widen Homepage" target="_blank" href="http://widen.com">Widen Enterprises, Inc.</a></p>

        <p><strong>Looking for work?</strong> <a title="Come engineer with us!" target="_blank" href="http://www.widen.com/careers/">Come engineer with us!</a></p>
        <p><strong>Something wrong with this page?</strong> Please <a title="Create new issue on bugtracker" target="_blank" href="https://github.com/widen/widen.github.io/issues/new">file a bug</a>.</p>
        <div class="git-info">
<nav>
  <ul class="inline">
    <li>
        <a target="_blank" title="View site source on GitHub" href="https://github.com/widen/widen.github.io">source</a>
    </li>
    <li>
        <a target="_blank" title="View current page on GitHub" href="https://github.com/widen/widen.github.io/blob/master/_posts/2021-04-24-Improving-CSS-Variables-in-WebKit.md">view</a>
    </li>
    <li>
        <a target="_blank" title="Edit current page on GitHub" href="https://github.com/widen/widen.github.io/edit/master/_posts/2021-04-24-Improving-CSS-Variables-in-WebKit.md">edit</a>
    </li>
    <li>
        <a target="_blank" title="Last site commit" href="https://github.com/widen/widen.github.io/commit/"></a>
    </li>
    <li>
        <a target="_blank" title="Last page commit" href="https://github.com/widen/widen.github.io/commit/"></a>
    </li>
  </ul>
  </nav >
</div>

    </footer>
</div>

    </div>

    
<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-1206716-19']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>


    <script src="https://unpkg.com/ionicons@5.1.2/dist/ionicons.js"></script>


  </body>

</html>
