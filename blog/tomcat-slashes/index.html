<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Tomcat Hates Encoded Slashes | Widen Engineering</title>
  <meta name="description" content="After sending a GET request containing escaped slashes to our Tomcat-hosted endpoint, we expect to receive a 2xx response. But instead, our server responds w...">

  <link rel="apple-touch-icon" sizes="57x57" href="/assets/images/favicon/apple-icon-57x57.png">
<link rel="apple-touch-icon" sizes="60x60" href="/assets/images/favicon/apple-icon-60x60.png">
<link rel="apple-touch-icon" sizes="72x72" href="/assets/images/favicon/apple-icon-72x72.png">
<link rel="apple-touch-icon" sizes="76x76" href="/assets/images/favicon/apple-icon-76x76.png">
<link rel="apple-touch-icon" sizes="114x114" href="/assets/images/favicon/apple-icon-114x114.png">
<link rel="apple-touch-icon" sizes="120x120" href="/assets/images/favicon/apple-icon-120x120.png">
<link rel="apple-touch-icon" sizes="144x144" href="/assets/images/favicon/apple-icon-144x144.png">
<link rel="apple-touch-icon" sizes="152x152" href="/assets/images/favicon/apple-icon-152x152.png">
<link rel="apple-touch-icon" sizes="180x180" href="/assets/images/favicon/apple-icon-180x180.png">
<link rel="icon" type="image/png" sizes="192x192"  href="/assets/images/favicon/android-icon-192x192.png">
<link rel="icon" type="image/png" sizes="32x32" href="/assets/images/favicon/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="96x96" href="/assets/images/favicon/favicon-96x96.png">
<link rel="icon" type="image/png" sizes="16x16" href="/assets/images/favicon/favicon-16x16.png">

<link rel="manifest" href="/assets/images/favicon/manifest.json"">

<meta name="msapplication-TileColor" content="#B72822">
<meta name="msapplication-TileImage" content="/assets/images/favicon/ms-icon-144x144.png" | relative_url }}">
<meta name="theme-color" content="#B72822">

  <link rel="stylesheet" href="/assets/css/app.css">
  <link rel="canonical" href="https://engineering.widen.com/blog/tomcat-slashes/">
  <link rel="alternate" type="application/rss+xml" title="Widen Engineering" href="/feed.xml" />
</head>


  <body>

    <div class="full-width">
      <header class="site-header" role="banner">
  <div class="wrapper">
    <div class="logo">
      <a href="/">
        <img width="400" alt="Widen Engineering Logo" src="https://embed.widencdn.net/img/widen/c17yrvuaac/400px@2x/Widen Engineering White Logo.png?u=mcuc7i">
      </a>
    </div>
    
      <a class="subscribe" target="_blank" title="Email Subscription" href="https://feedburner.google.com/fb/a/mailverify?uri=WidenEngineering">Subscribe to Updates</a>
    
  </div>
</header>

    </div>

    <div class="wrapper">

      <main class="content" role="main">

        <div class="post">
    <header>
        <h1><a title="Tomcat Hates Encoded Slashes" href="/blog/tomcat-slashes/">Tomcat Hates Encoded Slashes</a></h1>
        <time datetime="2015-09-02T00:00:00-05:00">Sep 2, 2015</time> • Ray Nicholus
    </header>

    <article role="article">

      <p>Let’s picture a small segment of a typical web application in order to better understand this problem. We’ll focus mostly on the server here, but the client plays a key role as well. On the server, we have a REST endpoint that exists to proxy information from <em>another</em> endpoint. This handler accepts GET requests. The <em>other</em> endpoint to proxy is included as a path parameter. The signature of our endpoint handler looks something like this:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@GET</span>
<span class="nd">@Path</span><span class="o">(</span><span class="s">"proxy/{url}"</span><span class="o">)</span>
<span class="nc">String</span> <span class="nf">getData</span><span class="o">(</span><span class="nd">@PathParam</span><span class="o">(</span><span class="s">"url"</span><span class="o">)</span> <span class="nc">String</span> <span class="n">url</span><span class="o">);</span>
</code></pre></div></div>

<p>In case it is not already obvious, the above code is part of a Java interface, and the annotations are part of the <a href="https://docs.oracle.com/javaee/7/api/javax/ws/rs/package-summary.html">javax.ws.rs package</a>, which is a collection of interfaces and annotations that align with the <a href="https://jcp.org/en/jsr/detail?id=311">JSR 311 specification</a> maintained by the <a href="https://www.jcp.org/en/home/index">Java Community Process group</a>.</p>

<p>The exact implementation of the above endpoint method is unimportant, so I’ll omit it for the sake of brevity. When called, it will simply make a GET request to the address specified at the end of the <code class="language-plaintext highlighter-rouge">@Path</code>, which is stored in the <code class="language-plaintext highlighter-rouge">url</code> parameter. The response from the resource associated with this <code class="language-plaintext highlighter-rouge">url</code> will return some data in the response, and this data will then be returned to whichever client called our “proxy/” endpoint. Our client code may very well be running in a browser, in which case it may look something like this:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">resourceToProxy</span> <span class="o">=</span>
  <span class="nb">encodeURIComponent</span><span class="p">(</span><span class="dl">'</span><span class="s1">http://widen.com/careers</span><span class="dl">'</span><span class="p">)</span>

<span class="nx">fetch</span><span class="p">(</span><span class="dl">'</span><span class="s1">/proxy/</span><span class="dl">'</span> <span class="o">+</span> <span class="nx">resourceToProxy</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">response</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">ok</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">response</span><span class="p">.</span><span class="nx">text</span><span class="p">()</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">error</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">statusText</span><span class="p">)</span>
      <span class="nx">error</span><span class="p">.</span><span class="nx">response</span> <span class="o">=</span> <span class="nx">response</span>
      <span class="k">throw</span> <span class="nx">error</span>
    <span class="p">}</span>
  <span class="p">})</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">proxiedData</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// handle proxied data in response</span>
  <span class="p">})</span>
  <span class="p">.</span><span class="k">catch</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">error</span><span class="p">)</span>
  <span class="p">})</span>
</code></pre></div></div>

<p>The above client-side code utilizes the native <a href="http://davidwalsh.name/fetch">Fetch API</a>, but you could accomplish the same call with <a href="https://developer.mozilla.org/en-US/docs/Web/API/XMLHttpRequest"><code class="language-plaintext highlighter-rouge">XMLHttpRequest</code></a>. In fact, the client doesn’t even need to be browser-based - it could very well live on a server, coded in any language under the sun.</p>

<h2 id="the-problem">The problem</h2>

<p>After executing the above request, we would fully expect to receive a 2xx response from our server and then handle the proxied data via the success function of fetch’s returned promise. But instead, our error handler is invoked. Looking closer, we see that our server returned a response code of <a href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.4.5">404</a>. But we’ve clearly defined our endpoint, and even verified that our request is being properly set to this endpoint. So what happened?</p>

<h2 id="the-cause">The cause</h2>

<p>I left out one <em>minor</em> detail - our web server is <a href="http://tomcat.apache.org/">Apache Tomcat</a>, which is very common when Java is the primary server language. In version 6.0.10 (released around February of 2007), <a href="http://tomcat.apache.org/security-6.html#Fixed_in_Apache_Tomcat_6.0.10">the Tomcat team patched a security hole</a>. This involved treating encoded forward and backslashes in the URL as path delimiters. So, our URI of “/proxy/http%3A%2F%2Fwiden.com%2Fcareers” is being expanded to “/proxy/http%3A//widen.com/careers” <em>before</em> it is routed to a matching endpoint handler. Of course, this endpoint is not accounted for, and our server rejects the request as a result.</p>

<h2 id="the-solution">The solution</h2>

<p>There are two ways to work around this behavior. The first involves adjusting a Java system property on our application server. Setting the <code class="language-plaintext highlighter-rouge">org.apache.tomcat.util.buf.UDecoder.ALLOW_ENCODED_SLASH</code> system property to <code class="language-plaintext highlighter-rouge">true</code> should allow our request to go through as expected. The default value of this property is <code class="language-plaintext highlighter-rouge">false</code>. Another option involves switching our GET request to a POST and including the url to proxy in the message-body. This is arguably the safest option. If we take this route, our server endpoint will look like this:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@POST</span>
<span class="nd">@Path</span><span class="o">(</span><span class="s">"proxy/url"</span><span class="o">)</span>
<span class="nc">String</span> <span class="nf">getData</span><span class="o">(</span><span class="nc">String</span> <span class="n">url</span><span class="o">);</span>
</code></pre></div></div>

<p>The body of our POST request will be made available to our handler method via the <code class="language-plaintext highlighter-rouge">url</code> parameter. We will have to make a slight adjustment to our client-side code as well:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">resourceToProxy</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">http://widen.com/careers</span><span class="dl">'</span>
<span class="nx">fetch</span><span class="p">(</span><span class="dl">'</span><span class="s1">/proxy/url</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span><span class="na">method</span><span class="p">:</span> <span class="dl">'</span><span class="s1">POST</span><span class="dl">'</span><span class="p">,</span> <span class="na">body</span><span class="p">:</span> <span class="nx">resourceToProxy</span><span class="p">})</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">response</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">ok</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">response</span><span class="p">.</span><span class="nx">text</span><span class="p">()</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">error</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">statusText</span><span class="p">)</span>
      <span class="nx">error</span><span class="p">.</span><span class="nx">response</span> <span class="o">=</span> <span class="nx">response</span>
      <span class="k">throw</span> <span class="nx">error</span>
    <span class="p">}</span>
  <span class="p">})</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">proxiedData</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// handle proxied data in response</span>
  <span class="p">})</span>
  <span class="p">.</span><span class="k">catch</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">error</span><span class="p">)</span>
  <span class="p">})</span>
</code></pre></div></div>

<p>Note that there is no need to encode the proxy endpoint address anymore, since it is no longer part of the request URI. The changes to our JavaScript are limited to the first two lines of code. This will result in A POST request to our “/proxy/url” endpoint with a Content-Type of “text/plain”. As expected, the body of our request will contain the <code class="language-plaintext highlighter-rouge">resourceToProxy</code> value. After making these changes, everything works as intended, and we are able to successfully proxy a third-party endpoint through our server.</p>



    </article>

    
      
<div class="comments">
	<div id="disqus_thread"></div>
	<script type="text/javascript">
	    var disqus_shortname = 'widen-engineering';
	    (function() {
	        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
	        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
	        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
	    })();
	</script>
	<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>


    
</div>


      </main>

    </div>

    <div class="full-width">
      <div class="wrapper">
    <footer class="site-footer" role="contentinfo">
        <nav>
          <ul class="inline">
          
            
          
            
          
            
          
            
            <li>
                <a href="/open-source">Open Source Guidelines</a>
            </li>
            
          
            
          
            
          
            
          
          </ul>
          <br/>
        </nav >
        <nav aria-label="Social media links">
          <ul class="site-social-links inline">
              <li><a target="_blank" title="RSS Feed" href="/feed.xml"><ion-icon name="logo-rss"></ion-icon></a></li>
              <li><a target="_blank" title="GitHub" href="https://github.com/widen"><ion-icon name="logo-github"></ion-icon></a></li>
              <li><a target="_blank" title="Twitter" href="https://twitter.com/widendev"><ion-icon name="logo-twitter"></ion-icon></a></li>
          </ul>
        </nav>
        <p>© Copyright 2021, <a title="Widen Homepage" target="_blank" href="http://widen.com">Widen Enterprises, Inc.</a></p>
        <p><strong>Looking for work?</strong> <a title="Come engineer with us!" target="_blank" href="http://www.widen.com/careers/">Come engineer with us!</a></p>
        
<p><strong>Something wrong with this page?</strong> Please <a title="Create new issue on bugtracker" target="_blank" href="https://github.com/widen/widen.github.io/issues/new">file a bug</a>.</p>
<div class="git-info">
<nav aria-label="Site source and page information">
  <ul class="inline">
    <li>
        <a target="_blank" title="View site source on GitHub" href="https://github.com/widen/widen.github.io">source</a>
    </li>
    <li>
        <a target="_blank" title="View current page on GitHub" href="https://github.com/widen/widen.github.io/blob/master/_posts/2015-09-02-tomcat-slashes.md">view</a>
    </li>
    <li>
        <a target="_blank" title="Edit current page on GitHub" href="https://github.com/widen/widen.github.io/edit/master/_posts/2015-09-02-tomcat-slashes.md">edit</a>
    </li>
    <li>
        <a target="_blank" title="Last site commit" href="https://github.com/widen/widen.github.io/commit/"></a>
    </li>
    <li>
        <a target="_blank" title="Last page commit" href="https://github.com/widen/widen.github.io/commit/"></a>
    </li>
  </ul>
  </nav >
</div>


    </footer>
</div>

    </div>

    
<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-1206716-19']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>


    <script src="https://unpkg.com/ionicons@5.1.2/dist/ionicons.js"></script>


  </body>

</html>
