<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>AWS CloudFront User Authentication using Lambda@Edge | Widen Engineering</title>
  <meta name="description" content="We want to protect private S3 content distributed by Amazon's CloudFront service, but we don't want to run a proxy server to authenticate requests. We explai...">

  <link rel="apple-touch-icon" sizes="57x57" href="/assets/favicon/apple-icon-57x57-ff42219994f7b0f656ffcad0ba264a75.png">
<link rel="apple-touch-icon" sizes="60x60" href="/assets/favicon/apple-icon-60x60-ab8b491cd6f98d7a529486efabe4acdb.png">
<link rel="apple-touch-icon" sizes="72x72" href="/assets/favicon/apple-icon-72x72-f91dd5bd6c559a9e40a08b1deed6e431.png">
<link rel="apple-touch-icon" sizes="76x76" href="/assets/favicon/apple-icon-76x76-707077860f7779206dba9bb48d19a512.png">
<link rel="apple-touch-icon" sizes="114x114" href="/assets/favicon/apple-icon-114x114-14db05cbd372a5d6a08da6bc73ddc34b.png">
<link rel="apple-touch-icon" sizes="120x120" href="/assets/favicon/apple-icon-120x120-23990f59e240ceed96367c004a5e7fb2.png">
<link rel="apple-touch-icon" sizes="144x144" href="/assets/favicon/apple-icon-144x144-3d533b233e4578032b5dfc6d5c0efcaa.png">
<link rel="apple-touch-icon" sizes="152x152" href="/assets/favicon/apple-icon-152x152-444f94897e7ef7e70831f735c7c62a5e.png">
<link rel="apple-touch-icon" sizes="180x180" href="/assets/favicon/apple-icon-180x180-c14938a49be032ffbea32c8aedc5cb91.png">
<link rel="icon" type="image/png" sizes="192x192"  href="/assets/favicon/android-icon-192x192-cc3dce93709d292d764aac5decf8049a.png">
<link rel="icon" type="image/png" sizes="32x32" href="/assets/favicon/favicon-32x32-02f9df411973b3e68a1209a864af9ffd.png">
<link rel="icon" type="image/png" sizes="96x96" href="/assets/favicon/favicon-96x96-e973328488d9787937aadf45798e569d.png">
<link rel="icon" type="image/png" sizes="16x16" href="/assets/favicon/favicon-16x16-5558f12adefff3f88493750388234933.png">

<link rel="manifest" href="/assets/favicon/manifest-f5ec1febffe24c0f830fd7907521de82.json">

<meta name="msapplication-TileColor" content="#B72822">
<meta name="msapplication-TileImage" content="/assets/favicon/ms-icon-144x144-3d533b233e4578032b5dfc6d5c0efcaa.png">
<meta name="theme-color" content="#B72822">

  <link rel="stylesheet" href="/assets/app-e8f20f52771ff90bfe6c533f8adc01b7.css">
  <link rel="canonical" href="https://engineering.widen.com/blog/AWS-CloudFront-User-Authentication-using-Lambda@Edge/">
  <link rel="alternate" type="application/rss+xml" title="Widen Engineering" href="https://engineering.widen.com/feed.xml" />
</head>


  <body>

    <div class="full-width">
      <header class="site-header" role="banner">
    <div class="wrapper">
        <div class="logo">
            <a href="/">
                <img width="400" alt="Widen-Engineering-White-Logo" src="https://embed.widencdn.net/img/widen/c17yrvuaac/400px@2x/Widen Engineering White Logo.png?u=mcuc7i">
            </a>
        </div>
        <br class="clear"/>
  </div>

</header>

    </div>

    <div class="wrapper">

      <main class="content" role="main">

        <div class="post">
    <header>
        <h1><a title="AWS CloudFront User Authentication using Lambda@Edge" href="/blog/AWS-CloudFront-User-Authentication-using-Lambda@Edge/">AWS CloudFront User Authentication using Lambda@Edge</a></h1>
        <time datetime="2018-02-07T00:00:00-06:00">Feb 7, 2018</time> • Payton Garland
    </header>

    <article role="article">

      <p>Our CI system is configured to write build reports to a S3 bucket. However, we found that there’s no easy way to serve <strong>private</strong> files without running an EC2 instance with <a href="https://github.com/jcomo/s3-proxy">proxy software</a> or living with the limitations of <a href="https://pete.wtf/2012/05/01/how-to-setup-aws-s3-access-from-specific-ips/">IP address restrictions</a> using IAM rules.</p>

<p>CloudFront has a feature named <a href="http://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/private-content-restricting-access-to-s3.html#private-content-creating-oai-console">origin access identity</a> that allows you to serve private S3 content. The missing link is the ability to validate requests as they are received by CloudFront. On July 17, 2017, Amazon released a new AWS Lambda feature named <a href="https://docs.aws.amazon.com/lambda/latest/dg/lambda-edge.html">Lambda@Edge</a>. From a developer’s perspective, Lambda@Edge allows Node.js functions to inspect, and modify, requests as they arrive at CloudFront POPs around the world.</p>

<p>Having the ability to execute Lambda functions upon <em><a href="https://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/lambda-cloudfront-trigger-events.html">viewer request</a></em> gives us the opportunity to authenticate the request in any way we wish. For our initial proof of concept, we checked for basic authentication with a static username/password.</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="s1">'use strict'</span><span class="p">;</span>
<span class="nx">exports</span><span class="p">.</span><span class="nx">handler</span> <span class="o">=</span> <span class="p">(</span><span class="nx">event</span><span class="p">,</span> <span class="nx">context</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>

    <span class="kr">const</span> <span class="nx">request</span> <span class="o">=</span> <span class="nx">event</span><span class="p">.</span><span class="nx">Records</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">cf</span><span class="p">.</span><span class="nx">request</span><span class="p">;</span>
    <span class="kr">const</span> <span class="nx">headers</span> <span class="o">=</span> <span class="nx">request</span><span class="p">.</span><span class="nx">headers</span><span class="p">;</span>

    <span class="c1">// Configure authentication</span>
    <span class="kr">const</span> <span class="nx">authUser</span> <span class="o">=</span> <span class="s1">'widen-user'</span><span class="p">;</span>
    <span class="kr">const</span> <span class="nx">authPass</span> <span class="o">=</span> <span class="s1">'secret-password'</span><span class="p">;</span>

    <span class="c1">// Construct expected basic auth header value</span>
    <span class="kr">const</span> <span class="nx">authString</span> <span class="o">=</span> <span class="s1">'Basic '</span> <span class="o">+</span> <span class="k">new</span> <span class="nx">Buffer</span><span class="p">(</span><span class="nx">authUser</span> <span class="o">+</span> <span class="s1">':'</span> <span class="o">+</span> <span class="nx">authPass</span><span class="p">).</span><span class="nx">toString</span><span class="p">(</span><span class="s1">'base64'</span><span class="p">);</span>

    <span class="c1">// If basic auth header does not match, send WWW-Authenticate response</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">headers</span><span class="p">.</span><span class="nx">authorization</span> <span class="o">==</span> <span class="s1">'undefined'</span> <span class="o">||</span> <span class="nx">headers</span><span class="p">.</span><span class="nx">authorization</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">value</span> <span class="o">!=</span> <span class="nx">authString</span><span class="p">)</span> <span class="p">{</span>
        <span class="kr">const</span> <span class="nx">body</span> <span class="o">=</span> <span class="s1">'Unauthorized'</span><span class="p">;</span>
        <span class="kr">const</span> <span class="nx">response</span> <span class="o">=</span> <span class="p">{</span>
            <span class="na">status</span><span class="p">:</span> <span class="s1">'401'</span><span class="p">,</span>
            <span class="na">statusDescription</span><span class="p">:</span> <span class="s1">'Unauthorized'</span><span class="p">,</span>
            <span class="na">body</span><span class="p">:</span> <span class="nx">body</span><span class="p">,</span>
            <span class="na">headers</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">'www-authenticate'</span><span class="p">:</span> <span class="p">[{</span><span class="na">key</span><span class="p">:</span> <span class="s1">'WWW-Authenticate'</span><span class="p">,</span> <span class="na">value</span><span class="p">:</span><span class="s1">'Basic realm="Widen CI Artifacts"'</span><span class="p">}]</span>
            <span class="p">},</span>
        <span class="p">};</span>
        <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">response</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// Continue request processing if authentication passed</span>
    <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">request</span><span class="p">);</span>
<span class="p">};</span>
</code></pre>
</div>

<p>This works surprisingly well; however, there was a lot of room for improvement. The most glaring obvious scalability problem is having a single shared password. One option we considered was to extend this code to improve the loading of passwords; the major downsides were still needing to manually manage user credentials and requiring users to remember yet another password.</p>

<p>We use <a href="https://gsuite.google.com/">Google’s G Suite</a> internally for email; we thought if we were to leverage their support of <a href="http://openid.net/connect/">OpenID Connect</a> as a relying party we could completely remove the need for our Lambda@Edge function to know anything about usernames or passwords.</p>

<p>At this point, the plan seemed clear:</p>

<ol>
  <li>Configure CloudFront to inspect HTTP requests as they were received.</li>
  <li>If the request is not already <strong>authenticated</strong>, use one of the many <a href="http://openid.net/developers/certified/">OpenID implementations</a> to redirect the user to the Google login UX.</li>
  <li>Perform user <strong>authorization</strong> (email whitelist, Google Groups membership, etc.)</li>
  <li>Set a stateless JWT authentication token, as a cookie, with a configurable TTL.</li>
  <li>Redirect user to original request path.</li>
</ol>

<p>As is the case with every new project, the original plan never lasts long. Lambda@Edge has a few major <a href="https://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/cloudfront-limits.html#limits-lambda-at-edge">limitations</a> that interfered:</p>

<ol>
  <li>Max size of zipped Lambda function (including libraries) is 1MB</li>
  <li>Environment variables are not supported</li>
</ol>

<p>Having such a small size limit posed a big issue with the use of an OpenID implementation to interact with OpenID Connect providers. All of the supported implementations exceeded the 1MB limit alone (typically ~2MB). Writing the URL query parameter composition, focusing on the bare minimum we needed for full functionality, using the built-in functions in Node proved an easy way to keep us under the limit.</p>

<p>The lack of environment variables created another hurdle to overcome. The end goal for this project was to allow users to configure a function without having to edit source code. Not having environment variables at hand meant user-specific data must be stored in the uploaded Lambda@Edge Javascript function itself. The next best option seemed to be an interactive build script allowing the Lambda function to be dynamically built without having to manually edit a configuration file.</p>

<p>Although having a configuration file and build script seemed cumbersome at first, it proved to be a useful addition. The build script freed up expansion options greatly by easily processing user input and automating the creation of the ZIP file to upload to Lambda. For example, the build script will make structural changes to the project based on the selections chosen (e.g. moving the Google Groups authorization file to the root as auth.js).</p>

<p>After our set of detours, it was an open road. After completing the Google version, we also added support for GitHub and Microsoft authentication. The providers have different authorization methods based upon specific user data available in their authentication callback:</p>

<ul>
  <li><strong>Google</strong>: Hosted domain verification, email whitelist or Google Groups membership</li>
  <li><strong>Microsoft</strong>: Azure AD membership or Azure AD username whitelist</li>
  <li><strong>GitHub</strong>: Organization membership</li>
</ul>

<p><a href="https://github.com/widen/cloudfront-auth">cloudfront-auth</a> is now available on GitHub as an open source project under the <a href="https://opensource.org/licenses/ISC">ISC License</a>.</p>



    </article>

    
</div>


      </main>

    </div>

    <div class="full-width">
      <div class="wrapper">
    <footer class="site-footer" role="contentinfo">
        <nav>
          <ul class="inline">
          
            
          
            
          
            
          
            
          
          </ul>
          <br/>
        </nav >
        <nav>
          <ul class="site-social-links inline">
              <li><a target="_blank" title="RSS Feed" href="/feed.xml" class="ion-social-rss"></a></li>
              <li><a target="_blank" title="GitHub" href="https://github.com/Widen" class="ion-social-github"></a></li>
              <li><a target="_blank" title="Twitter" href="https://twitter.com/widendev" class="ion-social-twitter"></a></li>
          </ul>
        </nav>
        <p>© Copyright 2020, <a title="Widen Homepage" target="_blank" href="http://widen.com">Widen Enterprises, Inc.</a></p>

        <p><strong>Looking for work?</strong> <a title="Come engineer with us!" target="_blank" href="http://www.widen.com/careers/">Come engineer with us!</a></p>
        <p><strong>Something wrong with this page?</strong> Please <a title="Create new issue on bugtracker" target="_blank" href="https://github.com/widen/widen.github.io/issues/new">file a bug</a>.</p>
        <div class="git-info">
<nav>
  <ul class="inline">
    <li>
        <a target="_blank" title="View site source on GitHub" href="https://github.com/widen/widen.github.io/">source</a>
    </li>
    <li>
        <a target="_blank" title="View current page on GitHub" href="https://github.com/widen/widen.github.io/blob/develop/_posts/2018-02-07-AWS-CloudFront-User-Authentication-using-Lambda@Edge.md">view</a>
    </li>
    <li>
        <a target="_blank" title="Edit current page on GitHub" href="https://github.com/widen/widen.github.io/edit/develop/_posts/2018-02-07-AWS-CloudFront-User-Authentication-using-Lambda@Edge.md">edit</a>
    </li>
    <li>
        <a ="_blank" title="Last site commit" href="https://github.com/widen/widen.github.io/commit/0e8f8d6">0e8f8d6</a>
    </li>
    <li>
        <a target="_blank" title="Last page commit" href="https://github.com/widen/widen.github.io/commit/361f32c">361f32c</a>
    </li>
  </ul>
  </nav >
</div>

    </footer>
</div>

    </div>

    <script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-1206716-19']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>


  </body>

</html>
